{% extends 'base.html' %}
{% load static humanize %}

{% block content %}
<section>
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="text-dark fw-bold">Главная</h2>
    <form method="get" class="d-flex align-items-center gap-2" id="period-form">
      <input type="month" class="form-control" id="month" name="month"
             aria-label="Конец периода" value="{{ selected_month }}">
      <button class="btn btn-primary" type="submit" aria-label="Применить период">
        <i class='bx bx-check'></i>
      </button>
    </form>
  </div>

  <section class="row justify-content-between gy-3 mb-2">
    <!-- Общий доход -->
    <article class="col-sm-6 col-xl-3">
      <div class="card bg-primary">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div class="content-left">
              <span class="text-white">Общий доход</span>
              <div class="d-flex align-items-center my-1">
                <h5 class="mb-0 me-2 text-white">{{ total_incomes|default:0|intcomma }} ₽</h5>
                <p class="{% if incomes_growth > 0 %}text-success{% else %}text-danger{% endif %} mb-0">
                  {{ incomes_growth|floatformat:1 }}%
                </p>
              </div>
            </div>
            <div class="avatar">
              <span class="avatar-initial rounded bg-label-primary">
                <i class="bx bx-bar-chart bx-26px"></i>
              </span>
            </div>
          </div>
        </div>
      </div>
    </article>

    <!-- Продажи -->
    <article class="col-sm-6 col-xl-3">
      <div class="card bg-primary">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div class="content-left">
              <span class="text-white">Продажи</span>
              <div class="d-flex align-items-center my-1">
                <h5 class="mb-0 me-2 text-white">{{ total_sales|default:0|intcomma }} ₽</h5>
                <p class="{% if sales_growth > 0 %}text-success{% else %}text-danger{% endif %} mb-0">
                  {{ sales_growth|floatformat:1 }}%
                </p>
              </div>
            </div>
            <div class="avatar">
              <span class="avatar-initial rounded bg-label-primary">
                <i class="bx bx-cart bx-26px"></i>
              </span>
            </div>
          </div>
        </div>
      </div>
    </article>

    <!-- Общие расходы -->
    <article class="col-sm-6 col-xl-3">
      <div class="card bg-primary">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div class="content-left">
              <span class="text-white">Общие расходы</span>
              <div class="d-flex align-items-center my-1">
                <h5 class="mb-0 me-2 text-white">{{ total_expenses|default:0|intcomma }} ₽</h5>
                <p class="{% if expenses_growth > 0 %}text-success{% else %}text-danger{% endif %} mb-0">
                  {{ expenses_growth|floatformat:1 }}%
                </p>
              </div>
            </div>
            <div class="avatar">
              <span class="avatar-initial rounded bg-label-danger">
                <i class="bx bx-money bx-26px"></i>
              </span>
            </div>
          </div>
        </div>
      </div>
    </article>

    <!-- Чистая прибыль -->
    <article class="col-sm-6 col-xl-3">
      <div class="card bg-primary">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div class="content-left">
              <span class="text-white">Чистая прибыль</span>
              <div class="d-flex align-items-center my-1">
                <h5 class="mb-0 me-2 text-white">{{ profit|default:0|intcomma }} ₽</h5>
              </div>
            </div>
            <div class="avatar">
              <span class="avatar-initial rounded bg-label-success">
                <i class="bx bx-wallet bx-26px"></i>
              </span>
            </div>
          </div>
        </div>
      </div>
    </article>
  </section>

  <div class="row gy-2">
    <div class="col-lg-8 col-sm-12">
      <div class="card h-100">
        <div class="card-header">
          <h5>График продаж</h5>
        </div>
        <div class="card-body">
          <canvas id="myChart" class="chartjs"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-sm-12">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="card-title m-0 me-2">Топ продаж</h5>
        </div>
        <div class="card-body pt-4">
          <ul class="p-0 m-0">
            {% for sale in top_sold_products %}
            <li class="d-flex align-items-center mb-2">
              <div class="avatar flex-shrink-0 me-3">
                <img src="{% static 'assets/img/icons/unicons/wallet.png' %}" alt="User" class="rounded">
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                <div class="me-2">
                  <small class="d-block">{{ sale.total_quantity }} {{ sale.product__unit }}</small>
                  <h6 class="fw-normal mb-0" data-bs-toggle="tooltip" data-bs-offset="0,6" data-bs-placement="top"
                    data-bs-html="true" data-bs-original-title="<span>{{ sale.product__name }}</span>">
                    {{ sale.product__name|truncatechars:15 }}</h6>
                </div>
                <div class="user-progress d-flex align-items-center gap-2">
                  <h6 class="fw-normal mb-0">+{{ sale.total_amount|intcomma }}</h6>
                  <span class="text-body-secondary">СОМ</span>
                </div>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/jquery"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  $(document).ready(function () {
    const ctx = document.getElementById('myChart');
    $.ajax({
      url: "{% url 'get-chart-data' %}",
      method: 'GET',
      success: function (data) {
        
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.months,
            datasets: [{
              label: 'Продажи',
              data: data.totals,
              borderWidth: 2
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
    })


  })
</script>
{% endblock content %}